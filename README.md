# Strange Room

一个基于 WebRTC 的端到端加密临时协作空间，支持白板、代码编辑和实时聊天。

## 项目简介

Strange Room 是一个专为临时协作设计的 Web 应用。它采用点对点（P2P）通信架构，所有数据直接在用户设备之间传输，服务器仅负责信令交换，不存储任何业务数据。房间具有自动销毁机制，在设定的有效期结束后永久删除所有数据。

## 核心特性

### 安全与隐私
- 端到端加密：使用 Web Crypto API 实现真正的端到端加密，密钥仅在客户端生成和存储
- 零数据存储：服务器仅处理信令交换，不保存任何聊天内容、白板数据或代码
- 自动销毁：支持 1/6/24/48 小时有效期，到期后房间数据自动清除
- 匿名使用：无需注册登录，不收集个人信息
- 设备指纹：基于浏览器特征生成唯一用户标识，确保跨会话一致性

### 协作功能
- 实时白板：多人同时绘图，支持画笔、形状、橡皮擦
- 代码协同：内置 Monaco 编辑器，支持多种编程语言语法高亮
- 实时聊天：群组聊天，支持文本消息
- 光标追踪：实时显示其他用户的鼠标位置

### 技术优势
- P2P 架构：数据不经过中转服务器
- 低延迟：基于 WebRTC 的实时通信
- 离线可用：核心功能在浏览器本地运行
- 跨平台：支持桌面和移动端浏览器

## 技术架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Strange Room 系统架构                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐                    ┌──────────────┐                    ┌──────────────┐
│   用户 A     │                    │ 信令服务器   │                    │   用户 B     │
│  (浏览器)    │                    │  (Node.js)   │                    │  (浏览器)    │
└──────┬───────┘                    └──────┬───────┘                    └──────┬───────┘
       │                                    │                                    │
       │  1. 创建/加入房间请求               │                                    │
       │ ─────────────────────────────────▶ │                                    │
       │                                    │                                    │
       │  2. 返回房间ID + Token              │                                    │
       │ ◀───────────────────────────────── │                                    │
       │                                    │                                    │
       │  3. WebSocket 连接 (y-websocket)   │    3. WebSocket 连接              │
       │ ─────────────────────────────────▶ │ ◀───────────────────────────────── │
       │                                    │            (只转发二进制消息)        │
       │                                    │                                    │
       │  4. WebRTC 信令交换                │                                    │
       │ ─────────────────────────────────▶ │ ─────────────────────────────────▶ │
       │ ◀───────────────────────────────── │ ◀───────────────────────────────── │
       │                                    │                                    │
       ▼                                    ▼                                    ▼
┌─────────────────────────┐         ┌─────────────────────────┐         ┌─────────────────────────┐
│   前端应用 (Next.js)    │         │                         │         │   前端应用 (Next.js)    │
├─────────────────────────┤         ├─────────────────────────┤         ├─────────────────────────┤
│ ┌─────────────────────┐ │         │                         │         │ ┌─────────────────────┐ │
│ │  页面层 (App Router)│ │         │                         │         │ │  页面层 (App Router)│ │
│ │  ├── page.tsx       │ │         │                         │         │ │  ├── page.tsx       │ │
│ │  ├── room/[id]/     │ │         │                         │         │ │  ├── room/[id]/     │ │
│ │  └── join/[id]/     │ │         │                         │         │ │  └── join/[id]/     │ │
│ └─────────────────────┘ │         │                         │         │ └─────────────────────┘ │
│ ┌─────────────────────┐ │         │                         │         │ ┌─────────────────────┐ │
│ │  组件层 (Components)│ │         │                         │         │ │  组件层 (Components)│ │
│ │  ├── RoomHeader     │ │         │                         │         │ │  ├── RoomHeader     │ │
│ │  ├── Whiteboard     │ │         │                         │         │ │  ├── Whiteboard     │ │
│ │  ├── MonacoEditor   │ │         │                         │         │ │  ├── MonacoEditor   │ │
│ │  └── ChatBox        │ │         │                         │         │ │  └── ChatBox        │ │
│ └─────────────────────┘ │         │                         │         │ └─────────────────────┘ │
│ ┌─────────────────────┐ │         │                         │         │ ┌─────────────────────┐ │
│ │  业务逻辑层 (Hooks) │ │         │                         │         │ │  业务逻辑层 (Hooks) │ │
│ │  ├── useRoom        │ │         │                         │         │ │  ├── useRoom        │ │
│ │  ├── useYjs         │ │         │                         │         │ │  ├── useYjs         │ │
│ │  └── useE2E         │ │         │                         │         │ │  └── useE2E         │ │
│ └─────────────────────┘ │         │                         │         │ └─────────────────────┘ │
│ ┌─────────────────────┐ │         │                         │         │ ┌─────────────────────┐ │
│ │  核心库层 (Lib)     │ │         │                         │         │ │  核心库层 (Lib)     │ │
│ │ ┌─────────────────┐ │ │         │                         │         │ │ ┌─────────────────┐ │ │
│ │ │ crypto/         │ │ │         │                         │         │ │ │ crypto/         │ │ │
│ │ │ ├── e2e-crypto  │ │ │         │                         │         │ │ │ ├── e2e-crypto  │ │ │
│ │ │ └── key-manager │ │ │         │                         │         │ │ │ └── key-manager │ │ │
│ │ ├─────────────────┤ │ │         │                         │         │ │ ├─────────────────┤ │ │
│ │ │ yjs/            │ │ │         │                         │         │ │ │ yjs/            │ │ │
│ │ │ ├── y-doc       │ │ │         │                         │         │ │ │ ├── y-doc       │ │ │
│ │ │ └── y-provider  │ │ │         │                         │         │ │ │ └── y-provider  │ │ │
│ │ ├─────────────────┤ │ │         │                         │         │ │ ├─────────────────┤ │ │
│ │ │ room/           │ │ │         │                         │         │ │ │ room/           │ │ │
│ │ │ └── room-manager│ │ │         │                         │         │ │ │ └── room-manager│ │ │
│ │ └─────────────────┘ │ │         │                         │         │ │ └─────────────────┘ │ │
│ └─────────────────────┘ │         │                         │         │ └─────────────────────┘ │
│ ┌─────────────────────┐ │         │                         │         │ ┌─────────────────────┐ │
│ │  存储层             │ │         │                         │         │ │  存储层             │ │
│ │  ├── IndexedDB      │ │         │                         │         │ │  ├── IndexedDB      │ │
│ │  └── localStorage   │ │         │                         │         │ │  └── localStorage   │ │
│ └─────────────────────┘ │         │                         │         │ └─────────────────────┘ │
└─────────────────────────┘         └─────────────────────────┘         └─────────────────────────┘
       │                                    │                                    │
       │                                    │                                    │
       ▼                                    ▼                                    ▼
┌─────────────────────────┐         ┌─────────────────────────┐         ┌─────────────────────────┐
│     P2P 数据同步        │         │                         │         │     P2P 数据同步        │
├─────────────────────────┤         ├─────────────────────────┤         ├─────────────────────────┤
│  Yjs CRDT 同步引擎      │         │                         │         │  Yjs CRDT 同步引擎      │
│  ├── 白板数据           │         │                         │         │  ├── 白板数据           │
│  ├── 代码编辑器         │         │                         │         │  ├── 代码编辑器         │
│  └── 聊天消息           │         │                         │         │  └── 聊天消息           │
└─────────────────────────┘         └─────────────────────────┘         └─────────────────────────┘
       │                                    │                                    │
       └──────────────── P2P 直连 ─────────────────────────────────────────────┘
                    (WebRTC DataChannel / y-websocket)

┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据流说明                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│ 1. 创建/加入: 客户端 → 信令服务器 → 返回 Token                              │
│ 2. WebSocket: 客户端 ←→ 信令服务器 ←→ 客户端 (只转发，不存储)                │
│ 3. P2P 同步: 客户端 ←→ 客户端 (WebRTC 直连，Yjs CRDT)                      │
│ 4. 端到端加密: 消息在发送前加密，接收后解密 (服务器无法窥探)                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 前端技术栈
- **框架**: Next.js 15 (App Router)
- **UI 组件**: Ant Design 5
- **样式**: Tailwind CSS
- **协同编辑**: Yjs + y-websocket (二进制协议)
- **代码编辑**: Monaco Editor
- **状态管理**: React Hooks
- **加密**: Web Crypto API (端到端加密)

### 后端技术栈
- **信令服务器**: Node.js + WebSocket (ws)
- **P2P 通信**: WebRTC
- **数据同步**: Yjs 协同引擎
- **协议**: WebSocket 二进制消息转发

### 目录结构详解
```
Strange-room/
├── src/                        # 前端源代码
│   ├── app/                    # Next.js App Router
│   │   ├── page.tsx           # 首页 (创建房间入口)
│   │   ├── layout.tsx         # 根布局
│   │   ├── room/[id]/         # 房间页面
│   │   │   └── page.tsx       # 房间主页面
│   │   └── join/[id]/         # 加入房间页面
│   │       └── page.tsx       # 邀请链接验证页面
│   │
│   ├── components/             # React 组件
│   │   ├── home.tsx           # 首页主组件
│   │   ├── Room/              # 房间相关组件
│   │   │   ├── RoomHeader.tsx # 房间头部 (倒计时、邀请、销毁)
│   │   │   ├── RoomLayout.tsx # 房间布局
│   │   │   └── UserList.tsx   # 用户列表
│   │   ├── Whiteboard/        # 白板组件
│   │   │   ├── Whiteboard.tsx # 白板主组件
│   │   │   ├── Canvas.tsx     # 画布
│   │   │   ├── Toolbar.tsx    # 工具栏
│   │   │   └── CursorTracker.tsx # 光标追踪
│   │   ├── Editor/            # 代码编辑器
│   │   │   └── MonacoEditor.tsx
│   │   ├── Chat/              # 聊天组件
│   │   │   ├── ChatBox.tsx    # 聊天框
│   │   │   └── MessageList.tsx # 消息列表
│   │   └── ui/                # 通用 UI 组件
│   │
│   ├── hooks/                 # 自定义 React Hooks
│   │   ├── useRoom.ts         # 房间管理 Hook
│   │   ├── useYjs.ts          # Yjs 协同引擎 Hook
│   │   └── useE2E.ts          # 端到端加密 Hook
│   │
│   ├── lib/                   # 核心工具库
│   │   ├── crypto/            # 加密模块
│   │   │   ├── e2e-crypto.ts  # 端到端加密实现
│   │   │   └── key-manager.ts # 密钥管理
│   │   ├── yjs/               # Yjs 协同引擎
│   │   │   ├── y-doc.ts       # Yjs 文档管理
│   │   │   └── y-provider.ts  # Yjs WebSocket 提供者
│   │   ├── room/              # 房间管理
│   │   │   └── room-manager.ts
│   │   ├── server/            # 服务器 API 客户端
│   │   │   └── api.ts
│   │   └── utils/             # 工具函数
│   │       ├── hash.ts        # 哈希工具
│   │       └── device-id.ts   # 设备指纹
│   │
│   └── types/                 # TypeScript 类型定义
│       ├── room.ts            # 房间类型
│       ├── yjs.ts             # Yjs 类型
│       └── crypto.ts          # 加密类型
│
├── server/                    # 信令服务器
│   ├── signaling-server.js    # 信令服务器主程序
│   ├── package.json           # 服务器依赖
│   └── utils/                 # 服务器工具
│       ├── crypto.js          # 令牌加密
│       └── rate-limiter.js    # 速率限制
│
├── electron/                  # Electron 桌面应用
│   ├── main.js                # 主进程
│   └── preload.js             # 预加载脚本
│
├── public/                    # 静态资源
├── build/                     # 构建输出
├── package.json               # 项目依赖
├── next.config.ts             # Next.js 配置
├── tsconfig.json              # TypeScript 配置
└── tailwind.config.js         # Tailwind CSS 配置
```

### 核心模块说明

#### 1. 信令服务器 (`server/signaling-server.js`)
- **职责**：房间管理、令牌验证、WebSocket 消息转发
- **特点**：零数据存储，仅转发二进制消息
- **API 端点**：
  - `POST /api/room/create` - 创建房间
  - `GET /api/room/check/:id` - 检查房间是否存在
  - `POST /api/token/generate` - 生成访问令牌
  - `POST /api/token/validate` - 验证访问令牌
  - `GET /health` - 健康检查

#### 2. 端到端加密 (`src/lib/crypto/`)
- **e2e-crypto.ts**：AES-GCM 256 位加密/解密
- **key-manager.ts**：密钥生成、存储和分享

#### 3. Yjs 协同引擎 (`src/lib/yjs/`)
- **y-doc.ts**：Yjs 文档初始化和类型管理
- **y-provider.ts**：WebSocket 连接和消息同步

#### 4. 房间管理 (`src/lib/room/`)
- **room-manager.ts**：房间生命周期管理、倒计时、销毁

#### 5. 自定义 Hooks (`src/hooks/`)
- **useRoom.ts**：封装房间状态和操作
- **useYjs.ts**：封装 Yjs 协同引擎
- **useE2E.ts**：封装端到端加密功能

## 快速开始

### 环境要求
- Node.js >= 18.0.0
- npm >= 9.0.0

### 安装步骤

1. 克隆项目
```bash
git clone https://github.com/BlkSword/Strange-room.git
cd Strange-room
```

2. 安装前端依赖
```bash
npm install
```

3. 安装服务器依赖
```bash
cd server
npm install
cd ..
```

4. 启动信令服务器
```bash
cd server
node signaling-server.js
```

5. 启动前端开发服务器
```bash
npm run dev
```

6. 访问应用

打开浏览器访问 [http://localhost:3000](http://localhost:3000)

### 生产部署

1. 构建前端
```bash
npm run build
```

2. 启动生产服务器
```bash
npm start
```

## 使用指南

### 创建房间
1. 访问主页，点击"创建房间"按钮
2. 输入房间名称（可选）和你的昵称
3. 选择房间有效期（1/6/24/48 小时）
4. 确认创建，系统生成邀请链接

### 加入房间
1. 通过创建者分享的邀请链接访问
2. 输入你的昵称
3. 点击"加入"按钮进入协作空间

### 房间功能
- **白板**：点击画笔工具开始绘图，支持多人同时编辑
- **代码编辑**：在编辑器中编写代码，支持语法高亮和自动补全
- **聊天**：在聊天框输入消息，与房间成员实时交流
- **用户列表**：查看当前在线的所有用户

### 销毁房间
- 房间创建者可以随时手动销毁房间
- 所有数据将被永久删除，无法恢复
- 有效期结束后房间自动销毁

## 安全说明

### 端到端加密
- 基于 AES-GCM 256 位加密算法
- 密钥在创建者浏览器本地生成，服务器无法获取
- 加密密钥通过邀请链接安全分享给房间成员
- 聊天消息在发送前加密，接收后解密
- 服务器仅转发加密数据，无法查看明文内容

### 数据传输
- 所有通信通过 Yjs + WebSocket 二进制协议
- 数据直接在用户浏览器之间同步
- 信令服务器仅交换连接信息，无法窥探通信内容
- WebSocket 连接在房间不存在时正确关闭，避免无效重连

### 数据存储
- 房间数据存储在浏览器 IndexedDB 中
- 本地加密存储，其他应用无法访问
- 房间销毁后本地数据同步清除
- 设备指纹存储在本地，确保同一设备上的用户 ID 一致性

### 隐私保护
- 无需注册账号，不收集个人信息
- 不使用 Cookie 或追踪技术
- 不连接第三方统计服务
- 用户 ID 基于昵称和设备指纹生成，同一昵称在不同设备上产生不同 ID

## 更新日志

### v2.0.0 (最新)
**重大重构：项目架构全面升级**

新增功能：
- 端到端加密：基于 Web Crypto API 的 AES-GCM 256 位加密
- 设备指纹：10 维浏览器特征采集，生成稳定的设备标识
- 加密密钥管理：创建者生成密钥，通过邀请链接分享给成员

问题修复：
- 修复 Yjs 二进制消息同步问题（画板、代码编辑器）
- 修复用户列表更新延迟（改用事件驱动机制）
- 修复时间同步重复校正问题（添加执行守卫）
- 修复浏览器刷新后状态丢失问题
- 修复空昵称导致的错误
- 修复 WebSocket 无限重连循环问题

性能优化：
- 用户列表更新从轮询改为事件驱动（awareness.on('change')）
- 画板同步添加 100ms 节流，减少网络传输
- Yjs 事件监听器正确清理，防止内存泄漏

技术改进：
- 信令服务器正确转发 y-websocket 二进制协议
- 用户 ID 生成算法改为"昵称+设备指纹"哈希
- 服务器统一错误码和关闭原因
- 事件监听器返回取消订阅函数

### v1.0.0
- 初始版本发布
- 基础房间创建和加入功能
- 实时白板、代码编辑、聊天功能


## 许可证

本项目基于 Apache-2.0 开源，详见 [LICENSE](LICENSE) 文件。
